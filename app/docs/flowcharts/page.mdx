# Diagramy procesÃ³w (Flowcharts)

Wizualne przedstawienie przepÅ‚ywu pracy w systemie CNC-Pilot.

## ğŸ‘¤ Proces rejestracji uÅ¼ytkownika

```mermaid
flowchart TD
    A[Start: UÅ¼ytkownik odwiedza /register] --> B{Email firmowy?}
    B -->|NIE - gmail/wp/onet| C[âŒ BÅ‚Ä…d: UÅ¼yj email sÅ‚uÅ¼bowy]
    B -->|TAK - email@firma.pl| D[WyciÄ…gnij domenÄ™: firma.pl]
    D --> E{Domena w bazie?}
    E -->|NIE| F[âŒ BÅ‚Ä…d: Firma nie zarejestrowana]
    E -->|TAK| G[ZnajdÅº company_id dla domeny]
    G --> H[UtwÃ³rz konto w auth.users]
    H --> I[Trigger: Auto-create profile]
    I --> J[Dodaj rekord do users z company_id]
    J --> K[Status: Pending - czeka na aktywacjÄ™]
    K --> L[Email potwierdzajÄ…cy]
    L --> M{Admin aktywuje?}
    M -->|NIE| N[Konto pozostaje Pending]
    M -->|TAK| O[Zmiana roli: Operator/Manager/Admin]
    O --> P[Email: Konto aktywowane]
    P --> Q[âœ… User moÅ¼e siÄ™ zalogowaÄ‡]
```

**Kluczowe punkty:**
- Tylko sÅ‚uÅ¼bowe emaile
- Automatyczne przypisanie do firmy po domenie
- Wymaga aktywacji przez admina

---

## ğŸ” Proces logowania

```mermaid
flowchart TD
    A[Start: User wchodzi na /login] --> B[Wprowadza email + hasÅ‚o]
    B --> C{Dane poprawne?}
    C -->|NIE| D[âŒ BÅ‚Ä…d: NieprawidÅ‚owe dane]
    C -->|TAK| E[Supabase tworzy sesjÄ™]
    E --> F[Pobierz profil z users]
    F --> G{Rola = Pending?}
    G -->|TAK| H[âŒ Redirect: /pending-activation]
    G -->|NIE| I{Rola aktywna?}
    I -->|NIE| J[âŒ Konto nieaktywne]
    I -->|TAK| K[Middleware: OdÅ›wieÅ¼ sesjÄ™]
    K --> L[âœ… Redirect: /dashboard]
```

**Kluczowe punkty:**
- Pending nie moÅ¼e siÄ™ zalogowaÄ‡
- Session auto-refresh przez middleware
- Redirect do dashboard po sukcesie

---

## ğŸ“¦ Tworzenie zamÃ³wienia

```mermaid
flowchart TD
    A[Start: User klika + Nowe zamÃ³wienie] --> B[Formularz: Dane zamÃ³wienia]
    B --> C{Walidacja front-end}
    C -->|BÅ‚Ä™dy| D[PokaÅ¼ komunikaty bÅ‚Ä™dÃ³w]
    C -->|OK| E[Pobierz company_id z auth]
    E --> F[Dodaj company_id do danych]
    F --> G[INSERT do orders]
    G --> H{Sukces?}
    H -->|NIE| I[âŒ Toast: BÅ‚Ä…d zapisu]
    H -->|TAK| J[âœ… Toast: ZamÃ³wienie utworzone]
    J --> K[Redirect: /orders]
    K --> L[Router.refresh - odÅ›wieÅ¼ listÄ™]
    L --> M[ZamÃ³wienie widoczne na liÅ›cie]
```

**Kluczowe punkty:**
- company_id zawsze z serwera, nigdy z clienta
- Toast feedback dla usera
- Router.refresh aby zobaczyÄ‡ zmiany

---

## â±ï¸ Åšledzenie czasu pracy

```mermaid
flowchart TD
    A[Start: User wybiera zamÃ³wienie] --> B[Kliknij Start]
    B --> C[SprawdÅº: Czy ma aktywny timer?]
    C -->|TAK| D[âŒ BÅ‚Ä…d: Zatrzymaj poprzedni timer]
    C -->|NIE| E[INSERT time_log: status=running]
    E --> F[Snapshot: hourly_rate z users]
    F --> G[start_time = NOW]
    G --> H[âœ… Timer aktywny - licznik]
    H --> I{User klika...}
    I -->|Pauza| J[UPDATE: status=paused]
    I -->|WznÃ³w| K[UPDATE: status=running]
    I -->|Stop| L[UPDATE: end_time=NOW, status=completed]
    L --> M[Oblicz: duration = end_time - start_time]
    M --> N[Oblicz: cost = duration Ã— hourly_rate]
    N --> O[âœ… Sesja zakoÅ„czona]
    O --> P[Aktualizuj metryki zamÃ³wienia]
```

**Kluczowe punkty:**
- Tylko 1 aktywny timer naraz
- Snapshot stawki (jeÅ›li stawka siÄ™ zmieni, stare sesje poprawne)
- Automatyczne obliczanie kosztu

---

## ğŸ“Š Wydanie materiaÅ‚u z magazynu

```mermaid
flowchart TD
    A[Start: User wybiera pozycjÄ™] --> B[Kliknij Wydanie]
    B --> C[Formularz: IloÅ›Ä‡ + ZamÃ³wienie]
    C --> D{IloÅ›Ä‡ > Stan?}
    D -->|TAK| E[âŒ BÅ‚Ä…d: Brak wystarczajÄ…cej iloÅ›ci]
    D -->|NIE| F[UPDATE inventory: quantity -= iloÅ›Ä‡]
    F --> G{PrzypisaÄ‡ do zamÃ³wienia?}
    G -->|NIE| H[INSERT inventory_movement: type=WZ]
    G -->|TAK| I[PowiÄ…Å¼ z order_id]
    I --> J[INSERT inventory_movement + order_id]
    J --> K[âœ… Toast: MateriaÅ‚ wydany]
    K --> L{Stan < PrÃ³g minimum?}
    L -->|TAK| M[ğŸ”´ Alert: Niski stan!]
    L -->|NIE| N[Status: OK]
    M --> O[Powiadomienie: ZamÃ³w materiaÅ‚]
    N --> P[Koniec]
    O --> P
```

**Kluczowe punkty:**
- Walidacja przed wydaniem
- Automatyczne alerty niskiego stanu
- Historia ruchÃ³w magazynowych

---

## ğŸ‘¥ Aktywacja uÅ¼ytkownika przez admina

```mermaid
flowchart TD
    A[Start: Nowy user zarejestrowany] --> B[Status: Pending w users]
    B --> C[Powiadomienie do Admin]
    C --> D[Admin: Lista uÅ¼ytkownikÃ³w]
    D --> E{Admin klika...}
    E -->|Aktywuj| F[Formularz: Wybierz rolÄ™]
    E -->|OdrzuÄ‡| G[UPDATE: status=inactive]
    F --> H{Rola wybrana}
    H --> I[UPDATE: role = operator/manager/admin]
    I --> J[âœ… Toast: UÅ¼ytkownik aktywowany]
    J --> K[Email do user: Konto aktywne]
    K --> L[User moÅ¼e siÄ™ zalogowaÄ‡]
    G --> M[Email: Rejestracja odrzucona]
    M --> N[User NIE moÅ¼e siÄ™ zalogowaÄ‡]
```

**Kluczowe punkty:**
- Pending = brak dostÄ™pu
- Admin wybiera rolÄ™ podczas aktywacji
- Email feedback do usera

---

## ğŸ”„ Multi-Tenancy - Izolacja danych

```mermaid
flowchart TD
    A[User A - Firma MetalTech] --> B[Zalogowany: company_id = uuid-metal]
    C[User B - Firma SteelWorks] --> D[Zalogowany: company_id = uuid-steel]

    B --> E[Query: SELECT * FROM orders]
    D --> F[Query: SELECT * FROM orders]

    E --> G[Middleware dodaje: WHERE company_id = uuid-metal]
    F --> H[Middleware dodaje: WHERE company_id = uuid-steel]

    G --> I[RLS Policy sprawdza]
    H --> J[RLS Policy sprawdza]

    I --> K[âœ… Zwraca tylko zamÃ³wienia MetalTech]
    J --> L[âœ… Zwraca tylko zamÃ³wienia SteelWorks]

    K --> M[User A widzi tylko swoje]
    L --> N[User B widzi tylko swoje]

    M --> O[âŒ NIE widzi danych SteelWorks]
    N --> P[âŒ NIE widzi danych MetalTech]
```

**Kluczowe punkty:**
- KaÅ¼dy query filtrowany po company_id
- RLS zapewnia izolacjÄ™ na poziomie bazy
- NiemoÅ¼liwe przypadkowe wyciek danych

---

## ğŸ“ˆ Generowanie raportu

```mermaid
flowchart TD
    A[Start: User wybiera Raporty] --> B[Wybierz typ: ZamÃ³wienia/Magazyn/Czas]
    B --> C[Ustaw filtry: daty/status/klient]
    C --> D[Kliknij Generuj]
    D --> E[Pobierz company_id z auth]
    E --> F[Query z filtrami + company_id]
    F --> G[Agregacja danych]
    G --> H[Oblicz metryki]
    H --> I{Format eksportu?}
    I -->|CSV| J[Generate CSV]
    I -->|Excel| K[Generate XLSX]
    I -->|PDF| L[Generate PDF]
    I -->|Ekran| M[Renderuj w przeglÄ…darce]
    J --> N[Download plik]
    K --> N
    L --> N
    M --> O[WyÅ›wietl raport]
    N --> P[âœ… Raport gotowy]
    O --> P
```

**Kluczowe punkty:**
- Zawsze filtruj po company_id
- Wiele formatÃ³w eksportu
- Zapisywanie ulubionych raportÃ³w

---

## ğŸ”§ Notacja

**KsztaÅ‚ty:**
- ğŸŸ¦ ProstokÄ…t - Proces/akcja
- ğŸ”· Romb - Decyzja (TAK/NIE)
- ğŸ”´ OkrÄ…g - Start/Stop
- ğŸ“„ Dokument - Output/raport

**Kolory:**
- âœ… Zielony - Sukces
- âŒ Czerwony - BÅ‚Ä…d
- ğŸ”µ Niebieski - Proces
- ğŸŸ¡ Å»Ã³Å‚ty - Czekanie/pending

---

## ğŸ“š WiÄ™cej diagramÃ³w

Potrzebujesz flowchart dla innego procesu?

**ZgÅ‚oÅ› proÅ›bÄ™:**
- Email: docs@cnc-pilot.app
- Temat: "Flowchart request: [nazwa procesu]"

**Planowane:**
- Proces fakturowania
- Integracja z systemami zewnÄ™trznymi
- Backup i restore danych
- Migracja miÄ™dzy planami cenowymi

---

## ğŸ› ï¸ NarzÄ™dzia

Diagramy stworzone w:
- **Mermaid.js** - Markdown-based diagramming
- **Draw.io** - Bardziej skomplikowane diagramy

**Edytuj wÅ‚asne:**
- [Mermaid Live Editor](https://mermaid.live)
- [Draw.io](https://app.diagrams.net)

---

**Wizualizacja pomaga w zrozumieniu!** ğŸ¯

JeÅ›li coÅ› jest niejasne - zobacz [FAQ](/docs/faq) lub [Video Tutoriale](/docs/video-tutorials).
